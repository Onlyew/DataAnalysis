<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据分析面板</title>
    <!-- 引入必要的CSS和JS库 (使用阿里云CDN) -->
    <link rel="stylesheet" href="https://g.alicdn.com/code/lib/bootstrap/4.6.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://g.alicdn.com/code/lib/font-awesome/5.15.3/css/all.min.css">
    <script src="https://g.alicdn.com/code/lib/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://g.alicdn.com/code/lib/jquery/3.6.0/jquery.min.js"></script>
    <style>
        :root {
            --primary-color: #3076f6;
            --secondary-color: #1e88e5;
            --accent-color: #ffc107;
            --text-color: #333;
            --light-bg: #f8f9fc;
            --white: #ffffff;
            --gray-100: #f6f6f6;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --shadow: 0 .15rem 1.75rem 0 rgba(58, 59, 69, .1);
        }
        
        body {
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            color: var(--text-color);
        }
        
        /* 顶部导航栏 */
        .topbar {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            height: 60px;
            background-color: var(--white);
            box-shadow: var(--shadow);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .topbar-brand {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: bold;
        }
        
        .topbar-brand i {
            margin-right: 10px;
            font-size: 24px;
        }
        
        .topbar-nav {
            display: flex;
            align-items: center;
        }
        
        .refresh-info {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .refresh-info span {
            margin: 0 10px;
            color: var(--gray-600);
            font-size: 14px;
        }
        
        .refresh-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        
        .refresh-btn i {
            margin-right: 5px;
        }
        
        .refresh-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .refresh-interval {
            margin-left: 10px;
            border-radius: 4px;
            border: 1px solid var(--gray-300);
            padding: 6px;
            font-size: 14px;
            background-color: var(--white);
        }
        
        /* 内容容器 */
        .content-wrapper {
            margin-top: 60px;
            padding: 10px;
        }
        
        /* 图表卡片 */
        .chart-card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 10px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 .25rem 2rem 0 rgba(58, 59, 69, .15);
        }
        
        .chart-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .chart-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .chart-actions {
            display: flex;
            align-items: center;
        }
        
        /* 全屏按钮样式 */
        .fullscreen-btn {
            cursor: pointer;
            margin-left: 8px;
            padding: 4px 8px;
            font-size: 14px;
            color: #666;
            background-color: #f5f5f5;
            border-radius: 4px;
            transition: all 0.3s;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullscreen-btn:hover {
            background-color: #e6f7ff;
            color: #1890ff;
            border-color: #1890ff;
        }
        
        .fullscreen-btn i {
            margin-right: 4px;
        }
        
        /* 全屏模式的容器 */
        .fullscreen-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
        }
        
        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .fullscreen-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .fullscreen-close {
            cursor: pointer;
            padding: 5px 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-size: 14px;
            border: 1px solid #ddd;
        }
        
        .fullscreen-close:hover {
            background-color: #ffeaea;
            color: #ff4d4f;
            border-color: #ff4d4f;
        }
        
        .fullscreen-chart {
            flex: 1;
            width: 100%;
            height: calc(100% - 60px);
        }
        
        .chart-body {
            padding: 20px;
            height: 300px;
        }
        
        /* 统计卡片 */
        .stat-card {
            background-color: var(--white);
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
            box-shadow: var(--shadow);
            padding: 10px 12px;
            margin-bottom: 10px;
            height: auto;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 .25rem 2rem 0 rgba(58, 59, 69, .15);
        }
        
        .stat-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2px;
        }
        
        .stat-change {
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        .stat-change.positive {
            color: #28a745;
        }
        
        .stat-change.negative {
            color: #dc3545;
        }
        
        .stat-change i {
            margin-right: 5px;
        }
        
        .text-success {
            color: #28a745 !important;
        }
        .text-warning {
            color: #ffc107 !important;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        
        /* 统计分区标题样式 */
        .stats-section-title {
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 4px;
            margin-top: 6px;
            margin-bottom: 8px;
        }
        
        /* 倒计时动画 */
        @keyframes countdown-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .countdown-active {
            animation: countdown-pulse 1s infinite;
        }
        
        /* 范围杀率样式 */
        .range-item {
            text-align: center;
            border-radius: 4px;
            background-color: #f8f9fa;
            padding: 2px 6px;
            width: 18%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .range-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 1px;
            font-size: 0.8rem;
        }
        
        .range-body {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .range-value {
            font-weight: 600;
            color: #007bff;
            background-color: rgba(0,123,255,0.1);
            border-radius: 3px;
            padding: 0 4px;
            margin: 2px 0;
        }
        
        .range-period {
            font-size: 0.7rem;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .range-diff {
            font-size: 0.7rem;
            color: #ff6600;
            margin-top: 2px;
        }
    </style>
</head>
<body>
<!-- 顶部导航栏 -->
<div class="topbar">
    <div class="topbar-brand">
        <i class="fas fa-chart-line"></i> 数据分析平台
    </div>
    <div class="topbar-nav">
        <div class="refresh-info">
            <span id="last-update-time">最后更新: 正在加载...</span>
            <span id="countdown" class="countdown-active"></span>
        </div>
        <button class="refresh-btn" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> 立即刷新
        </button>
        <select id="refresh-interval" class="refresh-interval">
            <option value="0">关闭自动刷新</option>
            <option value="10000">每10秒刷新</option>
            <option value="30000">每30秒刷新</option>
            <option value="60000">每1分钟刷新</option>
            <option value="300000">每5分钟刷新</option>
        </select>
    </div>
</div>

<!-- 主内容区 -->
<div class="content-wrapper">


    <!-- 图表仪表盘摘要统计 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-title">最新期数总和</div>
                <div id="latest-total" class="stat-value">--</div>
                <div id="latest-trend" class="stat-change">
                    <i class="fas fa-arrow-up"></i> 还未加载数据
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-title">平均值</div>
                <div id="average-value" class="stat-value">--</div>
                <div class="stat-change">总<span id="total-periods">0</span>期数据</div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-title">最大值</div>
                <div id="max-value" class="stat-value">--</div>
                <div id="max-period" class="stat-change">期数: --</div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-title">最小值</div>
                <div id="min-value" class="stat-value">--</div>
                <div id="min-period" class="stat-change">期数: --</div>
            </div>
        </div>
    </div>

    <!-- 连杀统计 -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="stat-card">
                <div class="stat-title">历史最大连杀</div>
                <div id="max-kill-streak" class="stat-value">--</div>
                <div id="kill-streak-period" class="stat-change">
                    <i class="fas fa-history"></i> 期数区间: --
                </div>
                <div id="kill-streak-diff" class="stat-change" style="margin-top:3px;">
                    <i class="fas fa-clock"></i> 距现在: <span id="period-diff">--</span>期
                </div>
                <div class="range-kills-container" style="display:flex; margin-top:5px; justify-content:space-between; flex-wrap:wrap; font-size:0.85rem; color:#666;">
                    <div class="range-row" style="display:flex; width:100%; justify-content:space-between; margin-bottom:5px;">
                        <div class="range-item">
                            <div class="range-header">1-100期:</div>
                            <div class="range-body">
                                <span id="range-100" class="range-value">--</span>
                                <div id="range-100-period" class="range-period"></div>
                                <div id="range-100-diff" class="range-diff"></div>
                            </div>
                        </div>
                        <div class="range-item">
                            <div class="range-header">101-200期:</div>
                            <div class="range-body">
                                <span id="range-200" class="range-value">--</span>
                                <div id="range-200-period" class="range-period"></div>
                                <div id="range-200-diff" class="range-diff"></div>
                            </div>
                        </div>
                        <div class="range-item">
                            <div class="range-header">201-300期:</div>
                            <div class="range-body">
                                <span id="range-300" class="range-value">--</span>
                                <div id="range-300-period" class="range-period"></div>
                                <div id="range-300-diff" class="range-diff"></div>
                            </div>
                        </div>
                        <div class="range-item">
                            <div class="range-header">301-400期:</div>
                            <div class="range-body">
                                <span id="range-400" class="range-value">--</span>
                                <div id="range-400-period" class="range-period"></div>
                                <div id="range-400-diff" class="range-diff"></div>
                            </div>
                        </div>
                        <div class="range-item">
                            <div class="range-header">401-500期:</div>
                            <div class="range-body">
                                <span id="range-500" class="range-value">--</span>
                                <div id="range-500-period" class="range-period"></div>
                                <div id="range-500-diff" class="range-diff"></div>
                            </div>
                        </div>
                    </div>
                    <div class="range-row" style="display:flex; width:100%; justify-content:space-between;">
                        <div class="range-item">
                            <div class="range-header">501-600期:</div>
                            <div class="range-body">
                                <span id="range-600" class="range-value">--</span>
                                <div id="range-600-period" class="range-period"></div>
                                <div id="range-600-diff" class="range-diff"></div>
                            </div>
                        </div>
                        <div class="range-item">
                            <div class="range-header">601-700期:</div>
                            <div class="range-body">
                                <span id="range-700" class="range-value">--</span>
                                <div id="range-700-period" class="range-period"></div>
                                <div id="range-700-diff" class="range-diff"></div>
                            </div>
                        </div>
                        <div class="range-item">
                            <div class="range-header">701-800期:</div>
                            <div class="range-body">
                                <span id="range-800" class="range-value">--</span>
                                <div id="range-800-period" class="range-period"></div>
                                <div id="range-800-diff" class="range-diff"></div>
                            </div>
                        </div>
                        <div class="range-item">
                            <div class="range-header">801-900期:</div>
                            <div class="range-body">
                                <span id="range-900" class="range-value">--</span>
                                <div id="range-900-period" class="range-period"></div>
                                <div id="range-900-diff" class="range-diff"></div>
                            </div>
                        </div>
                        <div class="range-item">
                            <div class="range-header">901-1000期:</div>
                            <div class="range-body">
                                <span id="range-1000" class="range-value">--</span>
                                <div id="range-1000-period" class="range-period"></div>
                                <div id="range-1000-diff" class="range-diff"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 被杀率统计 - 小场次 -->
    <div class="row mb-1">
        <div class="col-12">
            <h5 class="stats-section-title">小场次被杀率</h5>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">30场</div>
                <div id="kill-rate-30" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">50场</div>
                <div id="kill-rate-50" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">100场</div>
                <div id="kill-rate-100" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">150场</div>
                <div id="kill-rate-150" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">200场</div>
                <div id="kill-rate-200" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">250场</div>
                <div id="kill-rate-250" class="stat-value">--</div>
            </div>
        </div>
    </div>
    
    <!-- 被杀率统计 - 中场次 -->
    <div class="row mb-1">
        <div class="col-12">
            <h5 class="stats-section-title">中场次被杀率</h5>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">300场</div>
                <div id="kill-rate-300" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">350场</div>
                <div id="kill-rate-350" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">400场</div>
                <div id="kill-rate-400" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">450场</div>
                <div id="kill-rate-450" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">500场</div>
                <div id="kill-rate-500" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">550场</div>
                <div id="kill-rate-550" class="stat-value">--</div>
            </div>
        </div>
    </div>
    
    <!-- 被杀率统计 - 大场次和超大场次 -->
    <div class="row mb-1">
        <div class="col-12">
            <h5 class="stats-section-title">大场次被杀率</h5>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">600场</div>
                <div id="kill-rate-600" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">650场</div>
                <div id="kill-rate-650" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">700场</div>
                <div id="kill-rate-700" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">750场</div>
                <div id="kill-rate-750" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">800场</div>
                <div id="kill-rate-800" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">850场</div>
                <div id="kill-rate-850" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">900场</div>
                <div id="kill-rate-900" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">950场</div>
                <div id="kill-rate-950" class="stat-value">--</div>
            </div>
        </div>
        <div class="col-xl-1 col-lg-2 col-md-2 col-sm-3 col-4 mb-1">
            <div class="stat-card">
                <div class="stat-title">1000场</div>
                <div id="kill-rate-1000" class="stat-value">--</div>
            </div>
    </div>
    </div>

    <!-- 图表区域 -->
    <!-- SF1总和柱状图 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-bar"></i> 总和总量分析
                    </h5>
                    <div class="chart-actions">
                        <button class="btn btn-sm btn-outline-primary mr-2" id="zoom-reset-bar">
                            <i class="fas fa-home"></i> 重置缩放
                        </button>
                        <a href="javascript:void(0)" class="fullscreen-btn" onclick="showFullscreen('chart-structure', '总和总量分析')"><i class="fas fa-expand"></i> 全屏</a>
                    </div>
                </div>
                <div class="chart-body">
                    <div id="chart-structure" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SF1总和折线图 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">总数趋势分析</div>
                    <div class="chart-actions">
                        <button class="btn btn-sm btn-outline-primary mr-2" id="zoom-reset-line">
                            <i class="fas fa-home"></i> 重置缩放
                        </button>
                        <a href="javascript:void(0)" class="fullscreen-btn" onclick="showFullscreen('chart-trend', '总数趋势分析')"><i class="fas fa-expand"></i> 全屏</a>
                    </div>
                </div>
                <div class="chart-body">
                    <div id="chart-trend" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 杀号趋势折线图 -->
    <div class="row">
        <div class="col-md-12">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">杀号趋势分析</div>
                    <div class="chart-actions">
                        <button class="btn btn-sm btn-outline-primary mr-2" id="zoom-reset-kill">
                            <i class="fas fa-home"></i> 重置缩放
                        </button>
                        <a href="javascript:void(0)" class="fullscreen-btn" onclick="showFullscreen('chart-kill', '杀号趋势分析')"><i class="fas fa-expand"></i> 全屏</a>
                    </div>
                </div>
                <div class="chart-body">
                    <div id="chart-kill-trend" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加连接到历史连杀记录页面 -->
    <div class="row mt-4 mb-2">
        <div class="col-12 text-right">
            <a href="kill-streaks-history.html" class="btn btn-primary">
                <i class="fas fa-fire"></i> 查看历史连杀记录
            </a>
        </div>
    </div>
    
</div>

<!-- 全屏显示容器 -->
<div id="fullscreen-container" class="fullscreen-container">
    <div class="fullscreen-header">
        <div class="fullscreen-title" id="fullscreen-title">图表全屏显示</div>
        <button class="fullscreen-close" onclick="hideFullscreen()"><i class="fas fa-times"></i> 关闭</button>
    </div>
    <div id="fullscreen-chart" class="fullscreen-chart"></div>
</div>


<script>
    // 全局变量
    var structureChart, trendChart, killTrendChart, fullscreenChart;
    var refreshTimer, countdownTimer, currentFullscreenChartType;
    
    // 页面加载完成后执行
    $(document).ready(function() {
        console.log('页面初始化开始...');
        
        // 检查是否需要恢复全屏状态
        setTimeout(function() {
            try {
                const savedFullscreenState = localStorage.getItem('fullscreenState');
                if (savedFullscreenState) {
                    const state = JSON.parse(savedFullscreenState);
                    if (state.isFullscreen && state.chartId && state.title) {
                        // 如果所有图表已初始化完成，恢复全屏状态
                        if (structureChart && trendChart && killTrendChart) {
                            showFullscreen(state.chartId, state.title);
                        }
                    }
                }
            } catch (e) {
                console.error('恢复全屏状态失败:', e);
            }
        }, 1000); // 等待图表完全初始化
        
        // 初始化图表对象
        structureChart = echarts.init(document.getElementById('chart-structure'));
        trendChart = echarts.init(document.getElementById('chart-trend'));
        killTrendChart = echarts.init(document.getElementById('chart-kill-trend'));
        
        // 从API获取数据
        fetchSf1DataAndInitCharts();
        
        // 获取被杀率数据
        fetchRecentKillRates();
        
        // 获取杀号趋势数据
        fetchKillTrendData();
        
        // 绑定连杀记录过滤事件
        $("#min-streak-filter").change(function() {
            var minStreak = $(this).val();
            fetchKillStreaksHistory(minStreak);
        });
        
        // 初始化自动刷新控制
        initRefreshControl();
        
        // 为重置缩放按钮绑定事件
        $('#zoom-reset-bar').click(function() {
            // 重置缩放
            structureChart.dispatchAction({
                type: 'dataZoom',
                start: 0,
                end: 100
            });
            
            // 同时更新保存的缩放状态
            localStorage.setItem('barZoomState', JSON.stringify({
                start: 0,
                end: 100
            }));
        });
        
        $('#zoom-reset-line').click(function() {
            // 重置缩放
            trendChart.dispatchAction({
                type: 'dataZoom',
                start: 0,
                end: 100
            });
            
            // 同时更新保存的缩放状态
            localStorage.setItem('lineZoomState', JSON.stringify({
                start: 0,
                end: 100
            }));
        });
        
        $('#zoom-reset-kill').click(function() {
            // 重置缩放
            killTrendChart.dispatchAction({
                type: 'dataZoom',
                start: 0,
                end: 100
            });
            
            // 同时更新保存的缩放状态
            localStorage.setItem('killZoomState', JSON.stringify({
                start: 0,
                end: 100
            }));
        });
        
        // 添加缩放变化事件监听
        structureChart.on('datazoom', saveZoomState);
        trendChart.on('datazoom', saveZoomState);
        killTrendChart.on('datazoom', saveZoomState);
        
        // 在页面即将关闭时保存所有缩放状态
        window.addEventListener('beforeunload', function() {
            saveAllChartsZoomState();
        });
        
        // 窗口大小变化时自适应调整图表大小
        window.addEventListener('resize', function() {
            if(structureChart) structureChart.resize();
            if(trendChart) trendChart.resize();
            if(killTrendChart) killTrendChart.resize();
        });
    });
    
    // 初始化自动刷新控制
    function initRefreshControl() {
        console.log('初始化自动刷新控制...');
        // 更新当前时间
        updateCurrentTime();
        
        // 从localStorage读取上次设置的刷新间隔
        var savedInterval = localStorage.getItem('cashflow-refresh-interval');
        var refreshInterval = savedInterval ? parseInt(savedInterval) : 30000; // 默认30秒
        
        // 设置选择器默认值
        $('#refresh-interval').val(refreshInterval);
        
        // 监听刷新间隔变化
        $('#refresh-interval').change(function() {
            var interval = parseInt($(this).val());
            console.log('刷新间隔已更改为: ' + interval + 'ms');
            localStorage.setItem('cashflow-refresh-interval', interval);
            
            // 重置刷新计时器
            resetRefreshTimers();
            
            // 如果选择了自动刷新，设置新的计时器
            if (interval > 0) {
                console.log('启动自动刷新计时器...');
                startRefreshCountdown(interval);
                refreshTimer = setTimeout(function() {
                    console.log('执行自动刷新...');
                    location.reload();
                }, interval);
            } else {
                console.log('自动刷新已关闭');
                $('#countdown').text('').removeClass('countdown-active');
            }
        });
        
        // 触发change事件以启动计时器
        $('#refresh-interval').trigger('change');
    }
    
    // 重置所有刷新计时器
    function resetRefreshTimers() {
        if (refreshTimer) {
            clearTimeout(refreshTimer);
            refreshTimer = null;
        }
        
        if (countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }
    }
    
    // 更新当前时间
    function updateCurrentTime() {
        var now = new Date();
        var timeString = now.getFullYear() + '-' + 
                       padZero(now.getMonth() + 1) + '-' + 
                       padZero(now.getDate()) + ' ' + 
                       padZero(now.getHours()) + ':' + 
                       padZero(now.getMinutes()) + ':' + 
                       padZero(now.getSeconds());
        $('#last-update-time').text('最后更新: ' + timeString);
    }
    
    // 数字补零
    function padZero(num) {
        return (num < 10 ? '0' : '') + num;
    }
    
    // 开始刷新倒计时
    function startRefreshCountdown(interval) {
        var remaining = Math.floor(interval / 1000);
        updateCountdown(remaining);
        $('#countdown').addClass('countdown-active');
        
        countdownTimer = setInterval(function() {
            remaining--;
            updateCountdown(remaining);
            
            if (remaining <= 0) {
                clearInterval(countdownTimer);
            }
        }, 1000);
    }
    
    // 更新倒计时显示
    function updateCountdown(seconds) {
        $('#countdown').text(seconds > 0 ? seconds + '秒后自动刷新' : '即将刷新...');
    }
    
    // 获取SF1数据并初始化图表
    function fetchSf1DataAndInitCharts() {
        console.log('开始获取SF1数据...');
        $.ajax({
            url: '/api/sf1/total-number-data',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log('成功获取数据:', data);
                initCharts(data);
                updateDashboardStats(data);
                // 获取最大连杀数据
                fetchMaxConsecutiveKills();
            },
            error: function(xhr, status, error) {
                console.error('获取SF1数据失败:', error);
                // 使用模拟数据初始化图表，在真实环境中可以显示错误提示
                initCharts(null);
                // 尝试获取最大连杀数据
                fetchMaxConsecutiveKills();
            }
        });
    }
    
    // 获取所有至少5连杀及以上的历史记录
    function fetchKillStreaksHistory(minStreak = 5) {
        console.log('开始获取历史连杀记录...(最小连杀数=' + minStreak + ')');
        $.ajax({
            url: '/api/sf1/kill-streaks-history',
            type: 'GET',
            data: { minStreak: minStreak },
            dataType: 'json',
            success: function(data) {
                console.log('成功获取历史连杀记录:', data);
                // 清空表格
                $('#kill-streaks-history tbody').empty();
                
                if (data && data.streaks && data.streaks.length > 0) {
                    // 显示记录数量
                    $('#kill-streaks-count').text(data.count || 0);
                    
                    // 逐条添加记录
                    data.streaks.forEach(function(streak, index) {
                        var row = '<tr>';
                        row += '<td>' + (index + 1) + '</td>';
                        row += '<td class="highlight">' + streak.streakCount + '</td>';
                        row += '<td>' + streak.startPeriod + ' 至 ' + streak.endPeriod + '</td>';
                        
                        // 距离显示
                        if (streak.periodDiff !== undefined) {
                            var diffClass = '';
                            // 根据距离设置不同的样式
                            if (streak.periodDiff < 50) diffClass = 'text-danger';
                            else if (streak.periodDiff < 100) diffClass = 'text-warning';
                            else if (streak.periodDiff < 200) diffClass = 'text-primary';
                            
                            row += '<td class="' + diffClass + '">' + streak.periodDiff + '期</td>';
                        } else {
                            row += '<td>--</td>';
                        }
                        
                        row += '</tr>';
                        $('#kill-streaks-history tbody').append(row);
                    });
                } else {
                    // 没有记录
                    $('#kill-streaks-count').text('0');
                    $('#kill-streaks-history tbody').html(
                        '<tr><td colspan="4" class="text-center">没有找到符合条件的连杀记录</td></tr>'
                    );
                }
            },
            error: function(xhr, status, error) {
                console.error('获取历史连杀记录失败:', error);
                $('#kill-streaks-history tbody').html(
                    '<tr><td colspan="4" class="text-center">获取数据失败，请稍后再试</td></tr>'
                );
            }
        });
    }
    
    // 获取最大连杀数据
    function fetchMaxConsecutiveKills() {
        console.log('开始获取最大连杀数据...');
        $.ajax({
            url: '/api/sf1/multi-range-max-kills',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log('成功获取多范围最大连杀数据:', data);
                if (data) {
                    // 更新UI显示 - 全局最大连杀
                    $('#max-kill-streak').text(data.maxConsecutiveKills || '--');
                    
                    // 显示期数区间
                    if (data.startPeriod && data.endPeriod) {
                        $('#kill-streak-period').html(
                            '<i class="fas fa-history"></i> 期数区间: ' + 
                            data.startPeriod + ' 至 ' + data.endPeriod
                        );
                    } else {
                        $('#kill-streak-period').html('<i class="fas fa-history"></i> 期数区间: --');
                    }
                    
                    // 显示距离当前最新期的期数差
                    if (data.periodDiff !== undefined) {
                        $('#period-diff').text(data.periodDiff);
                    } else {
                        $('#period-diff').text('--');
                    }
                    
                    // 获取历史连杀记录
                    fetchKillStreaksHistory(5);
                    
                    // 更新不同范围内的最大连杀
                    updateRangeData(100, data);
                    updateRangeData(200, data);
                    updateRangeData(300, data);
                    updateRangeData(400, data);
                    updateRangeData(500, data);
                    updateRangeData(600, data);
                    updateRangeData(700, data);
                    updateRangeData(800, data);
                    updateRangeData(900, data);
                    updateRangeData(1000, data);
                    
                    // 获取历史连杀记录
                    fetchKillStreaksHistory();
                } else {
                    $('#max-kill-streak').text('--');
                    $('#kill-streak-period').html(
                        '<i class="fas fa-exclamation-circle"></i> 获取数据失败'
                    );
                    
                    // 清空范围数据
                    $('.range-value').text('--');
                    $('.range-period').text('');
                    $('.range-diff').text('');
                    $('#period-diff').text('--');
                }
            },
            error: function(xhr, status, error) {
                console.error('获取最大连杀数据失败:', error);
                $('#max-kill-streak').text('--');
                $('#kill-streak-period').html(
                    '<i class="fas fa-exclamation-circle"></i> 获取数据失败'
                );
                
                // 清空范围数据
                $('.range-value').text('--');
                $('.range-period').text('');
                $('.range-diff').text('');
                $('#period-diff').text('--');
                
                // 尝试获取历史连杀记录
                fetchKillStreaksHistory();
            }
        });
    }
    
    // 获取所有至少5连杀及以上的历史记录
    function fetchKillStreaksHistory(minStreak = 5) {
        console.log('开始获取历史连杀记录...');
        $.ajax({
            url: '/api/sf1/kill-streaks-history',
            type: 'GET',
            data: { minStreak: minStreak },
            dataType: 'json',
            success: function(data) {
                console.log('成功获取历史连杀记录:', data);
                if (data && data.streaks) {
                    // 清空表格
                    $('#kill-streaks-history tbody').empty();
                    
                    // 显示记录数量
                    $('#kill-streaks-count').text(data.count || 0);
                    
                    // 如果没有记录，显示提示
                    if (!data.streaks.length) {
                        $('#kill-streaks-history tbody').append(
                            '<tr><td colspan="4" class="text-center">没有找到符合条件的连杀记录</td></tr>'
                        );
                        return;
                    }
                    
                    // 逐条添加记录
                    data.streaks.forEach(function(streak, index) {
                        var row = '<tr>';
                        row += '<td>' + (index + 1) + '</td>';
                        row += '<td class="highlight">' + streak.streakCount + '</td>';
                        row += '<td>' + streak.startPeriod + ' 至 ' + streak.endPeriod + '</td>';
                        
                        // 距离显示
                        if (streak.periodDiff !== undefined) {
                            var diffClass = '';
                            // 根据距离设置不同的样式
                            if (streak.periodDiff < 50) diffClass = 'text-danger';
                            else if (streak.periodDiff < 100) diffClass = 'text-warning';
                            else if (streak.periodDiff < 200) diffClass = 'text-primary';
                            
                            row += '<td class="' + diffClass + '">' + streak.periodDiff + '期</td>';
                        } else {
                            row += '<td>--</td>';
                        }
                        
                        row += '</tr>';
                        $('#kill-streaks-history tbody').append(row);
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error('获取历史连杀记录失败:', error);
                $('#kill-streaks-history tbody').html(
                    '<tr><td colspan="4" class="text-center">获取数据失败，请稍后再试</td></tr>'
                );
            }
        });
    }
    
    // 更新范围数据，包括范围值和期数区间
    function updateRangeData(range, data) {
        if (data['range' + range] !== undefined) {
            $('#range-' + range).text(data['range' + range]);
            
            var startPeriod = data['range' + range + 'Start'];
            var endPeriod = data['range' + range + 'End'];
            var periodDiff = data['range' + range + 'Diff'];
            
            if (startPeriod && endPeriod) {
                $('#range-' + range + '-period').text(startPeriod + ' 至 ' + endPeriod);
            }
            
            if (periodDiff !== undefined) {
                $('#range-' + range + '-diff').text('距今: ' + periodDiff + '期');
            }
        }
    }
    
    // 获取近期被杀率数据
    function fetchRecentKillRates() {
        console.log('开始获取近期被杀率数据...');
        $.ajax({
            url: '/api/sf1/recent-kill-rates',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log('成功获取近期被杀率数据:', data);
                if (data) {
                    // 首先更新原有的三个被杀率
                    updateKillRateCard('30', data);
                    updateKillRateCard('50', data);
                    updateKillRateCard('100', data);
                    
                    // 更新150到1000场的被杀率，每50场一个间隔
                    for (let period = 150; period <= 1000; period += 50) {
                        updateKillRateCard(period.toString(), data);
                    }
                } else {
                    // 如果没有数据，设置所有被杀率为'--'
                    setAllKillRatesToDefault();
                }
            },
            error: function(xhr, status, error) {
                console.error('获取近期被杀率数据失败:', error);
                setAllKillRatesToDefault();
            }
        });
    }
    
    // 更新单个被杀率卡片
    function updateKillRateCard(period, data) {
        const elementId = 'kill-rate-' + period;
        const dataKey = 'killRate' + period;
        
        // 更新数值
        $('#' + elementId).text(data[dataKey] || '--');
        
        // 设置颜色
        if (data[dataKey]) {
            setKillRateColor(elementId, parseFloat(data[dataKey]));
        }
    }
    
    // 将所有被杀率设置为默认值
    function setAllKillRatesToDefault() {
        // 原有的三个被杀率
        $('#kill-rate-30').text('--');
        $('#kill-rate-50').text('--');
        $('#kill-rate-100').text('--');
        
        // 150到650场的被杀率，每50场一个间隔
        for (let period = 150; period <= 650; period += 50) {
            $('#kill-rate-' + period).text('--');
        }
    }
    
    // 根据杀率值设置颜色
    function setKillRateColor(elementId, rate) {
        if (isNaN(rate)) return;
        
        const element = $('#' + elementId);
        // 清除现有的颜色类
        element.removeClass('text-success text-warning text-danger');
        
        // 根据杀率值设置颜色
        if (rate < 30) {
            element.addClass('text-success'); // 低杀率，使用绿色
        } else if (rate < 70) {
            element.addClass('text-warning'); // 中等杀率，使用黄色
        } else {
            element.addClass('text-danger');  // 高杀率，使用红色
        }
    }
    
    // 更新仪表盘统计数据
    function updateDashboardStats(data) {
        if (!data || !data.periods || !data.totalNumbers) return;
        
        var periods = data.periods;
        var totalNumbers = data.totalNumbers;
        var totalPeriods = periods.length;
        
        // 更新期数统计
        $('#total-periods').text(totalPeriods);
        
        // 最新期数据（第一个元素，因为按period DESC排序）
        var latestTotal = totalNumbers[0];
        $('#latest-total').text(latestTotal);
        
        // 如果有多于1期数据，显示跟上一期的比较
        if (totalNumbers.length > 1) {
            var prevTotal = totalNumbers[1];
            var diff = latestTotal - prevTotal;
            var trendHtml = '';
            
            if (diff > 0) {
                trendHtml = '<i class="fas fa-arrow-up" style="color: #28a745;"></i> +' + diff + ' 相比上期';
                $('#latest-trend').addClass('positive').removeClass('negative').html(trendHtml);
            } else if (diff < 0) {
                trendHtml = '<i class="fas fa-arrow-down" style="color: #dc3545;"></i> ' + diff + ' 相比上期';
                $('#latest-trend').addClass('negative').removeClass('positive').html(trendHtml);
            } else {
                trendHtml = '<i class="fas fa-minus"></i> 无变化';
                $('#latest-trend').removeClass('positive negative').html(trendHtml);
            }
        }
        
        // 计算平均值
        var sum = totalNumbers.reduce(function(a, b) { return a + b; }, 0);
        var avg = sum / totalPeriods;
        $('#average-value').text(avg.toFixed(2));
        
        // 最大值和最小值
        var max = Math.max.apply(null, totalNumbers);
        var min = Math.min.apply(null, totalNumbers);
        
        var maxIndex = totalNumbers.indexOf(max);
        var minIndex = totalNumbers.indexOf(min);
        
        $('#max-value').text(max);
        $('#min-value').text(min);
        
        $('#max-period').text('期数: ' + periods[maxIndex]);
        $('#min-period').text('期数: ' + periods[minIndex]);
    }
    
    // 保存图表缩放状态
    function saveZoomState(evt) {
        try {
            // 确定是哪个图表触发的缩放事件
            var chart = evt.componentType === 'series' ? evt.target : null;
            
            if (!chart) {
                // 获取所有图表的缩放状态
                saveAllChartsZoomState();
                return;
            }
            
            // 判断哪个图表触发了缩放
            if (chart === structureChart) {
                var barOption = structureChart.getOption();
                var barDataZoom = barOption.dataZoom[0];
                localStorage.setItem('barZoomState', JSON.stringify({
                    start: barDataZoom.start,
                    end: barDataZoom.end
                }));
                console.log('保存柱状图缩放状态:', barDataZoom.start, barDataZoom.end);
            } 
            else if (chart === trendChart) {
                var lineOption = trendChart.getOption();
                var lineDataZoom = lineOption.dataZoom[0];
                localStorage.setItem('lineZoomState', JSON.stringify({
                    start: lineDataZoom.start,
                    end: lineDataZoom.end
                }));
                console.log('保存折线图缩放状态:', lineDataZoom.start, lineDataZoom.end);
            }
            else if (chart === killTrendChart) {
                var killOption = killTrendChart.getOption();
                var killDataZoom = killOption.dataZoom[0];
                localStorage.setItem('killZoomState', JSON.stringify({
                    start: killDataZoom.start,
                    end: killDataZoom.end
                }));
                console.log('保存杀号趋势图缩放状态:', killDataZoom.start, killDataZoom.end);
            }
        } catch (e) {
            console.error('保存缩放状态失败:', e);
        }
    }
    
    // 显示全屏图表
    function showFullscreen(chartId, title) {
        console.log('显示全屏图表:', chartId, title);
        
        // 设置标题
        $('#fullscreen-title').text(title);
        
        // 清空并初始化全屏图表容器
        if (fullscreenChart) {
            fullscreenChart.dispose();
        }
        
        // 显示全屏容器
        $('#fullscreen-container').css('display', 'flex');
        
        // 创建全屏图表
        fullscreenChart = echarts.init(document.getElementById('fullscreen-chart'));
        
        // 保存当前全屏图表类型
        currentFullscreenChartType = chartId;
        
        // 在localStorage中保存全屏状态
        localStorage.setItem('fullscreenState', JSON.stringify({
            isFullscreen: true,
            chartId: chartId,
            title: title
        }));
        
        let sourceChart;
        let sourceOption;
        
        // 根据不同图表类型复制相应的图表选项
        switch(chartId) {
            case 'chart-structure':
                sourceChart = structureChart;
                break;
            case 'chart-trend':
                sourceChart = trendChart;
                break;
            case 'chart-kill':
                sourceChart = killTrendChart;
                break;
        }
        
        if (sourceChart) {
            // 复制原始图表的选项
            sourceOption = sourceChart.getOption();
            
            // 确保Y轴高度不变
            if (sourceOption.yAxis && sourceOption.yAxis[0]) {
                // 复制Y轴设置，保持min和max值不变
                const yAxis = JSON.parse(JSON.stringify(sourceOption.yAxis[0])); 
                sourceOption.yAxis[0] = yAxis;
            }
            
            // 设置全屏图表选项
            fullscreenChart.setOption(sourceOption);
        }
        
        // 处理ESC键关闭全屏
        $(document).on('keydown.fullscreen', function(e) {
            if (e.key === 'Escape') {
                hideFullscreen();
            }
        });
        
        // 响应窗口大小变化
        $(window).on('resize.fullscreen', function() {
            if (fullscreenChart) {
                fullscreenChart.resize();
                
                // 保持Y轴设置不变
                if (sourceOption && sourceOption.yAxis && sourceOption.yAxis[0]) {
                    fullscreenChart.setOption({
                        yAxis: sourceOption.yAxis
                    });
                }
            }
        });
    }
    
    // 隐藏全屏图表
    function hideFullscreen() {
        console.log('隐藏全屏图表');
        
        // 隐藏全屏容器
        $('#fullscreen-container').css('display', 'none');
        
        // 保存非全屏状态
        localStorage.setItem('fullscreenState', JSON.stringify({
            isFullscreen: false
        }));
        
        // 将全屏图表的缩放状态同步回主图表
        if (fullscreenChart && currentFullscreenChartType) {
            var fullscreenOption = fullscreenChart.getOption();
            var targetChart;
            
            switch(currentFullscreenChartType) {
                case 'chart-structure':
                    targetChart = structureChart;
                    break;
                case 'chart-trend':
                    targetChart = trendChart;
                    break;
                case 'chart-kill':
                    targetChart = killTrendChart;
                    break;
            }
            
            if (targetChart && fullscreenOption.dataZoom && fullscreenOption.dataZoom[0]) {
                var dataZoom = fullscreenOption.dataZoom[0];
                targetChart.dispatchAction({
                    type: 'dataZoom',
                    start: dataZoom.start,
                    end: dataZoom.end
                });
            }
        }
        
        // 移除事件监听
        $(document).off('keydown.fullscreen');
        $(window).off('resize.fullscreen');
        
        // 释放全屏图表
        if (fullscreenChart) {
            fullscreenChart.dispose();
            fullscreenChart = null;
        }
        
        currentFullscreenChartType = null;
    }
    
    // 保存所有图表的缩放状态
    function saveAllChartsZoomState() {
        try {
            // 保存柱状图缩放状态
            if (structureChart) {
                var barOption = structureChart.getOption();
                var barDataZoom = barOption.dataZoom[0];
                localStorage.setItem('barZoomState', JSON.stringify({
                    start: barDataZoom.start,
                    end: barDataZoom.end
                }));
            }
            
            // 保存折线图缩放状态
            if (trendChart) {
                var lineOption = trendChart.getOption();
                var lineDataZoom = lineOption.dataZoom[0];
                localStorage.setItem('lineZoomState', JSON.stringify({
                    start: lineDataZoom.start,
                    end: lineDataZoom.end
                }));
            }
            
            // 保存杀号趋势图缩放状态
            if (killTrendChart) {
                var killOption = killTrendChart.getOption();
                var killDataZoom = killOption.dataZoom[0];
                localStorage.setItem('killZoomState', JSON.stringify({
                    start: killDataZoom.start,
                    end: killDataZoom.end
                }));
            }
            
            console.log('所有图表缩放状态已保存');
        } catch (e) {
            console.error('保存所有缩放状态失败:', e);
        }
    }
    
    // 获取保存的缩放状态
    function getSavedZoomState(chartType, defaultStart, defaultEnd) {
        try {
            var key = chartType + 'ZoomState';
            var savedState = localStorage.getItem(key);
            
            if (savedState) {
                var state = JSON.parse(savedState);
                console.log('读取到' + chartType + '缩放状态:', state);
                return state;
            }
        } catch (e) {
            console.error('获取缩放状态失败:', e);
        }
        
        // 如果没有保存过或出错，返回默认值
        console.log('使用' + chartType + '默认缩放状态:', defaultStart, defaultEnd);
        return { start: defaultStart, end: defaultEnd };
    }
    
    // 初始化图表
    function initCharts(apiData) {
        // 默认数据，当API调用失败时使用
        var defaultPeriods = ['001', '002', '003', '004', '005'];
        var defaultTotalNumbers = [14, 12, 18, 11, 15];
        
        // 使用API数据或默认数据
        var periods = apiData && apiData.periods ? apiData.periods : defaultPeriods;
        var totalNumbers = apiData && apiData.totalNumbers ? apiData.totalNumbers : defaultTotalNumbers;
        
        // 计算默认缩放比例
        var defaultBarZoomEnd = Math.min(100, 2000 / periods.length);
        var defaultLineZoomEnd = Math.min(100, 1500 / periods.length);
        
        // 获取保存的缩放状态
        var barZoomState = getSavedZoomState('bar', 0, defaultBarZoomEnd);
        var lineZoomState = getSavedZoomState('line', 0, defaultLineZoomEnd);
        
        // 1. 柱状图 - 总和总量分析
        var barCategories = periods.map(function(period) { return '期' + period; });
        
        structureChart.setOption({
            tooltip: {
                trigger: 'axis',
                formatter: '{b}: {c}',
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderColor: '#ccc',
                borderWidth: 1,
                textStyle: { color: '#333' },
                extraCssText: 'box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);'
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '10%',
                containLabel: true
            },
            dataZoom: [{
                type: 'slider',
                show: true,
                xAxisIndex: [0],
                start: barZoomState.start,
                end: barZoomState.end
            }, {
                type: 'inside',
                xAxisIndex: [0],
                start: barZoomState.start,
                end: barZoomState.end
            }],
            xAxis: {
                type: 'category',
                data: barCategories,
                axisLabel: {
                    interval: 0,
                    rotate: 45,
                    fontSize: 11
                },
                axisLine: { lineStyle: { color: '#ccc' } }
            },
            yAxis: {
                type: 'value',
                name: 'SF1总和',
                nameTextStyle: { color: '#666' },
                splitLine: { lineStyle: { type: 'dashed', color: '#eee' } },
                axisLine: { show: false }
            },
            series: [{
                name: 'SF1总和',
                type: 'bar',
                barWidth: '60%',
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: '#3076f6' },
                        { offset: 1, color: '#5ca2ff' }
                    ]),
                    borderRadius: [3, 3, 0, 0]
                },
                data: totalNumbers,
                label: {
                    show: true,
                    position: 'top',
                    formatter: '{c}',
                    fontSize: 11,
                    fontWeight: 'bold',
                    color: '#333'
                },
                z: 10
            }],
            backgroundColor: 'transparent'
        });
        
        // 2. 折线图 - 总和波动图
        trendChart.setOption({
            tooltip: {
                trigger: 'axis',
                formatter: '期{b}: 总和{c}',
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderColor: '#ccc',
                borderWidth: 1,
                textStyle: { color: '#333' },
                extraCssText: 'box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);'
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '10%',
                containLabel: true
            },
            dataZoom: [{
                type: 'slider',
                show: true,
                xAxisIndex: [0],
                start: lineZoomState.start,
                end: lineZoomState.end
            }, {
                type: 'inside',
                xAxisIndex: [0],
                start: lineZoomState.start,
                end: lineZoomState.end
            }],
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: periods,
                axisLabel: {
                    interval: 'auto',
                    rotate: 45,
                    fontSize: 11
                },
                axisLine: { lineStyle: { color: '#ccc' } }
            },
            yAxis: {
                type: 'value',
                name: 'SF1总和',
                scale: true,
                nameTextStyle: { color: '#666' },
                splitLine: { lineStyle: { type: 'dashed', color: '#eee' } },
                axisLine: { show: false }
            },
            series: [{
                name: 'SF1总和',
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 5,
                sampling: 'average',
                itemStyle: { color: '#3076f6' },
                lineStyle: { width: 2, color: '#3076f6' },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: 'rgba(48, 118, 246, 0.3)'
                    }, {
                        offset: 1,
                        color: 'rgba(48, 118, 246, 0.1)'
                    }])
                },
                data: totalNumbers,
                label: {
                    show: true,
                    position: 'top',
                    formatter: '{c}',
                    fontSize: 11,
                    fontWeight: 'bold',
                    color: '#333'
                },
                markPoint: {
                    data: [
                        { type: 'max', name: '最大值' },
                        { type: 'min', name: '最小值' }
                    ]
                },
                z: 10
            }],
            backgroundColor: 'transparent'
        });
    }
    
    // 获取杀号趋势数据
    function fetchKillTrendData() {
        console.log('开始获取杀号趋势数据...');
        
        // 先尝试现有API
        $.ajax({
            url: '/api/sf1/history',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log('成功获取数据:', typeof data);
                
                // 处理返回的数据
                var records = processApiData(data);
                
                if (records && records.length > 0) {
                    updateKillTrendChart(records);
                } else {
                    console.warn('从默认API获取数据失败，尝试使用备用方案...');
                    createMockDataAndUpdateChart();
                }
            },
            error: function(xhr, status, error) {
                console.error('获取杀号趋势数据失败:', error);
                console.warn('尝试使用备用方案...');
                createMockDataAndUpdateChart();
            }
        });
    }
    
    // 处理API返回的数据
    function processApiData(data) {
        if (!data) return [];
        
        var records = [];
        
        // 检测数据类型
        if (Array.isArray(data)) {
            records = data;
        } else if (data.records && Array.isArray(data.records)) {
            records = data.records;
        } else if (data.period) {
            // 单条记录
            records = [data];
        }
        
        // 检查数据结构
        if (records.length > 0) {
            var sampleRecord = records[0];
            console.log('数据样本结构:', JSON.stringify(sampleRecord));
            
            // 检查数据是否含有杀号信息
            var hasKillInfo = false;
            
            // 检查所有可能的字段名
            var possibleFields = ['killNumber', 'kill_number', 'killnumber'];
            
            for (var i = 0; i < records.length; i++) {
                var record = records[i];
                for (var j = 0; j < possibleFields.length; j++) {
                    var field = possibleFields[j];
                    if (record[field] === '杀' || record[field] === '料') {
                        hasKillInfo = true;
                        console.log('找到杀号信息在字段:', field);
                        break;
                    }
                }
                if (hasKillInfo) break;
            }
            
            if (!hasKillInfo) {
                console.warn('数据中找不到杀号信息，检查第一条记录:', JSON.stringify(records[0]));
                return [];
            }
        }
        
        return records;
    }
    
    // 创建模拟数据并更新图表
    function createMockDataAndUpdateChart() {
        console.log('创建模拟数据...');
        
        console.log('创建了' + mockRecords.length + '条模拟数据');
        updateKillTrendChart(mockRecords);
    }
    
    // 处理并更新杀号趋势图表
    function updateKillTrendChart(records) {
        // 如果没有数据，显示提示信息
        if (!records || records.length === 0) {
            killTrendChart.setOption({
                title: {
                    text: '暂无杀号数据',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        color: '#999',
                        fontSize: 16
                    }
                }
            });
            return;
        }
        
        // 按期数倒序排列（最新的在前面）
        records.sort((a, b) => {
            return parseInt(b.period) - parseInt(a.period);
        });
        
        // 提取需要的数据：期数和杀号情况
        var periods = [];
        var killData = [];
        var binaryKillValues = []; // 二元值（0/1）
        
        // 当killNumber字段值为"杀"时，使用1表示，否则使用0表示
        records.forEach(function(record) {
            // 只显示期数的后三位
            let periodDisplay = record.period.toString();
            if (periodDisplay.length > 3) {
                periodDisplay = periodDisplay.substring(periodDisplay.length - 3);
            }
            periods.push(periodDisplay);
            
            // 处理不同可能的字段名和值格式
            let isKill = 0;
            // 显示记录字段信息便于调试
            if (record.period && (record.period === 7385 || record.period === 7386)) {
                console.log('检查关键记录:', record.period, 'killNumber值:', record.killNumber, 'kill_number值:', record.kill_number);
            }
            
            // 检查所有可能的字段名和值格式
            if (record.killNumber === "杀" || 
                record.kill_number === "杀" ||
                record.killNumber === "料" ||
                record.kill_number === "料") {
                isKill = 1;
            }
            
            killData.push({
                value: isKill,
                isKill: isKill === 1
            });
            binaryKillValues.push(isKill);
        });
        
        console.log('处理后的杀号数据样本：', periods.slice(0, 5), binaryKillValues.slice(0, 5));
        
        // 注意：不需要反转数组，因为数据已经按期数降序排列（最新的在前面）
        // 这样最新的数据就会显示在左侧
        
        // 计算连杀次数数组（累计值）
        var cumulativeKillValues = [];
        var continuousKillCount = 0;
        
        for (let i = 0; i < binaryKillValues.length; i++) {
            if (binaryKillValues[i] === 1) {
                continuousKillCount++;
                cumulativeKillValues.push(continuousKillCount);
            } else {
                continuousKillCount = 0;
                cumulativeKillValues.push(0);
            }
        }
        
        console.log('连杀累计数据样本:', cumulativeKillValues.slice(0, 10));
        
        // 计算连杀区域
        var markAreaData = [];
        continuousKillCount = 0;
        var startIndex = -1;
        
        // 检测连续的杀号
        for (let i = 0; i < binaryKillValues.length; i++) {
            if (binaryKillValues[i] === 1) {
                if (continuousKillCount === 0) {
                    startIndex = i;
                }
                continuousKillCount++;
            } else {
                if (continuousKillCount >= 2) {
                    // 只标记2连杀及以上
                    markAreaData.push([
                        { xAxis: startIndex },
                        { xAxis: startIndex + continuousKillCount }
                    ]);
                }
                continuousKillCount = 0;
            }
        }
        
        // 处理数据结束时仍在连杀的情况
        if (continuousKillCount >= 2) {
            markAreaData.push([
                { xAxis: startIndex },
                { xAxis: startIndex + continuousKillCount }
            ]);
        }
        
        // 为连杀点添加标记点
        var markPointData = [];
        
        for (let i = 0; i < cumulativeKillValues.length; i++) {
            let count = cumulativeKillValues[i];
            if (count >= 2) {
                markPointData.push({
                    value: count + '连杀',
                    xAxis: i,
                    yAxis: count,
                    symbolSize: 8 + count * 2, // 连杀越多，标记点越大
                    itemStyle: {
                        color: getKillColor(count)
                    }
                });
            }
        }
        
        // 计算合适的缩放比例
        var defaultZoomEnd = Math.min(100, Math.max(20, 2000 / periods.length));
        var killZoomState = getSavedZoomState('kill', 0, defaultZoomEnd);
        
        // 计算Y轴最大值（最大连杀数+1）
        var maxKillCount = Math.max.apply(null, cumulativeKillValues);
        maxKillCount = Math.max(maxKillCount, 5); // 至少显示到5
        
        // 设置图表选项
        killTrendChart.setOption({
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    var param = params[0];
                    var index = param.dataIndex;
                    var killCount = cumulativeKillValues[index];
                    if (killCount > 0) {
                        return '期' + periods[index] + ': ' + killCount + '连杀';
                    } else {
                        return '期' + periods[index] + ': 非杀';
                    }
                },
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderColor: '#ccc',
                borderWidth: 1,
                textStyle: { color: '#333' },
                extraCssText: 'box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);'
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '10%',
                containLabel: true
            },
            dataZoom: [{
                type: 'slider',
                show: true,
                xAxisIndex: [0],
                start: killZoomState.start,
                end: killZoomState.end
            }, {
                type: 'inside',
                xAxisIndex: [0],
                start: killZoomState.start,
                end: killZoomState.end
            }],
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: periods,
                axisLabel: {
                    interval: 0, // 显示所有标签
                    rotate: 45,
                    fontSize: 10,
                    margin: 2 
                },
                axisLine: { lineStyle: { color: '#ccc' } }
            },
            yAxis: {
                type: 'value',
                name: '连杀次数',
                nameTextStyle: { 
                    color: '#666',
                    fontSize: 12,
                    padding: [0, 0, 0, 30]
                },
                min: 0,
                max: maxKillCount,
                interval: 1,
                axisLabel: {
                    formatter: '{value}',
                    color: '#666',
                    fontSize: 11
                },
                splitLine: { lineStyle: { type: 'solid', color: '#f0f0f0' } },
                axisLine: { show: false }
            },
            series: [{
                name: '杀号趋势',
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: function(value) {
                    return value > 0 ? 8 : 0; // 仅在有数值的点显示
                },
                itemStyle: {
                    color: '#1890FF', // 统一的蓝色
                    borderColor: '#fff',
                    borderWidth: 1.5
                },
                lineStyle: { 
                    width: 3,
                    color: '#1890FF', // 统一的蓝色
                    cap: 'round',
                    join: 'round',
                    shadowBlur: 0
                },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: 'rgba(24, 144, 255, 0.3)'
                    }, {
                        offset: 1,
                        color: 'rgba(24, 144, 255, 0.05)'
                    }])
                },
                label: {
                    show: true,
                    position: 'top',
                    formatter: function(params) {
                        if (params.value > 0) {
                            return params.value;
                        }
                        return '';
                    },
                    fontSize: 12,
                    color: '#333',
                    fontWeight: 'bold'
                },
                data: cumulativeKillValues,
                // 移除标记点，使用简洁的数据标签
                
                z: 10
            }],
            backgroundColor: 'transparent'
        });
    }
    
    // 根据连杀次数获取颜色
    function getKillColor(count) {
        if (count >= 5) return '#1565C0'; // 深蓝色
        if (count >= 4) return '#1976D2'; // 蓝色
        if (count >= 3) return '#2196F3'; // 中蓝色
        if (count >= 2) return '#42A5F5'; // 浅蓝色
        return '#64B5F6'; // 浅淡蓝色
        if (count >= 3) return '#DC143C'; // 猩红色
        if (count >= 2) return '#FF4500'; // 橙红色
        return '#FF6347'; // 番茄色 (基础杀色)
    }
    
</script>
</body>
</html>